<html>
<head>
    <link rel="stylesheet" media="screen" href = "{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <script language="JavaScript" type="text/javascript" src="{{ url_for('static', filename='js/jquery-3.3.1.min.js') }}"></script>
    <script language="JavaScript" type="text/javascript" src="{{ url_for('static', filename='js/popper.js') }}"></script>
    <script language="JavaScript" type="text/javascript" src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <meta name="viewport" content = "width=device-width, initial-scale=1.0">    
    <style>
    /* Center the loader */
    #loader {
      position: absolute;
      left: 60%;
      top: 50%;
      z-index: 1;
      width: 150px;
      height: 150px;
      margin: -75px 0 0 -75px;
      border: 16px solid #f3f3f3;
      border-radius: 50%;
      border-top: 16px solid #3498db;
      width: 120px;
      height: 120px;
      -webkit-animation: spin 1s linear infinite;
      animation: spin 1s linear infinite;
      display:none;
    }

    @-webkit-keyframes spin {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Add animation to "page content" */
    .animate-bottom {
      position: relative;
      -webkit-animation-name: animatebottom;
      -webkit-animation-duration: 1s;
      animation-name: animatebottom;
      animation-duration: 1s
    }

    @-webkit-keyframes animatebottom {
      from { bottom:-100px; opacity:0 } 
      to { bottom:0px; opacity:1 }
    }

    @keyframes animatebottom { 
      from{ bottom:-100px; opacity:0 } 
      to{ bottom:0; opacity:1 }
    }
    </style>
</head>

<body class = "body">
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
  
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item dropdown active">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Bank
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item active" href="/bank-generate">Share Generation</a>
            <a class="dropdown-item" href="/bank-reconstruct">Share Reconstruction</a>
          </div>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="/client">Client</a>
        </li>

        <!--
        <li class="nav-item">
          <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
        </li>
        -->
      </ul>
      <!--
      <form class="form-inline my-2 my-lg-0">
        <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
      </form>
      -->
    </div>
  </nav>
  
  <div class="jumbotron">
      <div class="container">
        <div class="row">
          <div class="col">
            <h1 class="display-4">Admin Page (Share Generation)</h1>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <p class="lead">Use this panel to create 2 shares of a signature!</p>
            <hr class="my-4">
          </div>
        </div>
      </div>

      <form name="generation" method="post" enctype="multipart/form-data">
        <div class="container">
          <div class="row">
            <div class="col-6 input-group mb-2">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="signature-upload" required>
                    <label class="custom-file-label" for="signature-upload" aria-describedby="inputGroupFileAddon02">Choose Signature</label>
                </div>
            </div>
          </div>

          <div class="row">
            <div class="col-6 input-group mb-2">
              <div class="input-group-prepend">
                <span class="input-group-text" id="basic-addon1">Client's Email</span>
              </div>
              <input type="text" id="email_input" class="form-control" placeholder="johndoe@vsignit.com" aria-label="Username" aria-describedby="basic-addon1" required>
            </div>
          </div>

          <div class="row">
              <div class="col-5">
                <div id="loader"></div>
              </div>
          </div>

          <div class="row">
              <div class="col-5">
                <a id="downloadLink" target="_blank" value="bank_share" download><div id="preview" style="margin-bottom: 10px; max-height: 200px; max-width: 200px"></div></a>
              </div>
          </div>

          <div class="row">
           <div class="col-12">
              <div id="response-msg" class="alert alert-danger animate-bottom" role="alert" style="width:49%; text-align: center">
                  Please ensure that you have entered the correct email!
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <button class="btn btn-primary btn-lg active" type="submit" aria-pressed="true" style="width:49%">Generate Shares</button>
            </div>
          </div>
        </div>
      </form>
    </div>
</body>

<script>
    $('#response-msg').hide();

    $(".custom-file-input").on("change", function() {
        var fileName = $(this).val().split("\\").pop();
        $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
    });

    $(generation).submit(function(e) 
    {
      e.preventDefault(); // avoid to execute the actual submit of the form.
      
      document.getElementById("loader").style.display = "block";

      // checks if a picture is uploaded and 
      // the email is in the correct format
      if (validate())
        encodeImageFileAsURL()
    });

    function validateEmail(email) {
      var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(String(email).toLowerCase());
    }

    function validate() {
      $('#signature-upload').addClass('is-valid');
      var email = $(email_input).val()

      if (validateEmail(email)) {
        $('#email_input').removeClass('is-invalid');
        $('#email_input').addClass('is-valid');
        $('#response-msg').hide();
        return true;
      } 

      else
      {
        document.getElementById("loader").style.display = "none";
        $('#email_input').addClass('is-invalid');
        $('#response-msg').toggle();
        return false;
      }
    }

    function encodeImageFileAsURL()
    {
      var filesSelected = document.getElementById("signature-upload").files;

      if (filesSelected.length > 0) 
      {
        var fileToLoad = filesSelected[0];
        var fileReader = new FileReader();

        fileReader.onload = function(fileLoadedEvent) 
        {
          srcData = fileLoadedEvent.target.result; // <--- data: base64
          
          // store email and image (base64)
          var fd = new FormData();
          var email = $(email_input).val()
          var imgsrc = document.getElementById("preview").src;

          // send to server via AJAX
          fd.append('email', email)
          fd.append('file',srcData)

          var formData = new FormData(document.getElementById("generation"));
          $.ajax({
            type: 'post',
            url: '/bank-generate',
            data: fd,
            mimeType:"multipart/form-data",
            contentType: false,
            cache: false,
            processData: false,
            success: function(response){
                if(response != 0){
                  var png_download = "data:image/png;base64,"
                  png_download += response

                  var newImage = document.createElement('img');
                  newImage.src = png_download;
                  newImage.height = 200;
                  newImage.width = 200;
                  document.getElementById("preview").innerHTML = newImage.outerHTML;

                  var a = document.getElementById('downloadLink'); //or grab it by tagname etc
                  a.href = png_download
                  a.download = "bank_share"

                  // updates UI
                  document.getElementById("loader").style.display = "none";

                  $('#response-msg').removeClass('alert-danger');
                  $('#response-msg').addClass('alert-success');
                  $("#response-msg").text("Click on the image to download your share. The other share has been sent to \'" + email + "\'");
                  $('#response-msg').show();

                } else{
                    alert('file not uploaded');
                }
            },

            error: function(jqXHR, textStatus, errorThrown) 
            {}
          });
        }
        fileReader.readAsDataURL(fileToLoad);
      }
    }
</script>
