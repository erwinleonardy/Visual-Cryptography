<html>
<head>
    <link rel="stylesheet" media="screen" href = "{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <script language="JavaScript" type="text/javascript" src="{{ url_for('static', filename='js/jquery-3.3.1.min.js') }}"></script>
    <script language="JavaScript" type="text/javascript" src="{{ url_for('static', filename='js/popper.js') }}"></script>
    <script language="JavaScript" type="text/javascript" src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <meta name="viewport" content = "width=device-width, initial-scale=1.0">    
<style>
  .preview img{
    display: none;
  }
</style>
</head>

<body class = "body">
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
  
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item dropdown active">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Bank
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item active" href="/bank-generate">Share Generation</a>
            <a class="dropdown-item" href="/bank-reconstruct">Share Reconstruction</a>
          </div>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="/client">Client</a>
        </li>

        <!--
        <li class="nav-item">
          <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
        </li>
        -->
      </ul>
      <!--
      <form class="form-inline my-2 my-lg-0">
        <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
      </form>
      -->
    </div>
  </nav>
  
  <div class="jumbotron">
      <h1 class="display-4">Admin Page (Share Generation)</h1>
      <p class="lead">Use this panel to create 2 shares of a signature!</p>
      <hr class="my-4">

      <form name="reconstruct" method="post" enctype="multipart/form-data">
          <div class="input-group mb-2" style="width:40%">
              <div class="custom-file">
                  <input type="file" class="custom-file-input" id="signature-upload" required>
                  <label class="custom-file-label" for="inputGroupFile02" aria-describedby="inputGroupFileAddon02">Choose Signature</label>
              </div>
          </div>

          <div id="imgTest" style="margin-bottom: 10px"></div>

          <div class="input-group mb-3" style="width:40%">
            <div class="input-group-prepend">
              <span class="input-group-text" id="basic-addon1">Client's Email</span>
            </div>
            <input type="text" id="email_input" class="form-control" placeholder="johndoe@vsignit.com" aria-label="Username" aria-describedby="basic-addon1" required>
          </div>

          <div id="response-msg" class="alert alert-danger" role="alert" style="width:40%; text-align: center">
              Please ensure that you have entered the correct email!
          </div>
  
          <button class="btn btn-primary btn-lg active" type="submit" aria-pressed="true" style="width:40%">Generate Shares</button>
      </form>
      <div class='preview'>
        <img src="" id="img" width="100" height="100">
      </div>
    </div>
</body>

<script>
    $('#response-msg').hide();

    // Add the following code if you want the name of the file appear on select
    $(".custom-file-input").on("change", function() {
        var fileName = $(this).val().split("\\").pop();
        $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
    });

    $(reconstruct).submit(function(e) 
    {
      e.preventDefault(); // avoid to execute the actual submit of the form.
      
      // checks if a picture is uploaded and 
      // the email is in the correct format
      if (validate())
      {
        console.log("before")
        encodeImageFileAsURL()
      } 
    });

    function validateEmail(email) {
      var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(String(email).toLowerCase());
    }

    function validate() {
      var email = $(email_input).val()

      if (validateEmail(email)) {
        $('#email_input').removeClass('is-invalid');
        $('#email_input').addClass('is-valid');
        $('#response-msg').toggle();
        return true;
      } 

      $('#email_input').addClass('is-invalid');
      $('#response-msg').toggle();
      return false;
    }

    function encodeImageFileAsURL()
    {
      var filesSelected = document.getElementById("signature-upload").files;

      if (filesSelected.length > 0) {
        var fileToLoad = filesSelected[0];

        var fileReader = new FileReader();

        fileReader.onload = function(fileLoadedEvent) {
          srcData = fileLoadedEvent.target.result; // <--- data: base64

          var newImage = document.createElement('img');
          newImage.src = srcData;

          document.getElementById("imgTest").innerHTML = newImage.outerHTML;
          // alert("Converted Base64 version is " + srcData);
          // console.log("Converted Base64 version is " + document.getElementById("imgTest").innerHTML);
          
          var email = $(email_input).val()
          var fd = new FormData();

          $('#response-msg').removeClass('alert-danger');
          $('#response-msg').addClass('alert-success');
          $("#response-msg").text("Your share has been downloaded! The other share has been sent to \'" + email + "\'");
          $('#response-msg').show();
          $('#signature-upload').addClass('is-valid');

          var imgsrc = document.getElementById("imgTest").src;
          // console.log(srcData)

          fd.append('email', email)
          fd.append('file',srcData)

          var formData = new FormData(document.getElementById("reconstruct"));
          $.ajax({
            type: 'post',
            url: '/bank-generate',
            data: fd,
            mimeType:"multipart/form-data",
            contentType: false,
            cache: false,
            processData: false,
            success: function(response){
              
                if(response != 0){

                }else{
                    alert('file not uploaded');
                }
            },

            error: function(jqXHR, textStatus, errorThrown) 
            {
                  // Oops! Some Error
            }
          });
        }
        fileReader.readAsDataURL(fileToLoad);
      }
    }
</script>
