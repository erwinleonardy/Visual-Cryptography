<html>

<head>
  <link rel="icon" href="{{ url_for('static', filename='img/favicon.ico') }}" type="image/x-icon"/>
  <link rel="stylesheet" media="screen" href = "{{ url_for('static', filename='css/common.css') }}">
  <link rel="stylesheet" media="screen" href = "{{ url_for('static', filename='css/bootstrap.min.css') }}">
  <script language="JavaScript" type="text/javascript" src="{{ url_for('static', filename='js/jquery-3.3.1.min.js') }}"></script>
  <script language="JavaScript" type="text/javascript" src="{{ url_for('static', filename='js/popper.js') }}"></script>
  <script language="JavaScript" type="text/javascript" src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
  <meta name="viewport" content = "width=device-width, initial-scale=1.0">    
</head>

<!-- Body -->
<body class = "body">
  <!-- Nav Bar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">

    <a class="navbar-brand" href="#">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="">
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
  
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item dropdown active">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Bank
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" href="/bank-generate">Share Generation</a>
            <a class="dropdown-item active" href="/bank-reconstruct">Share Reconstruction</a>
          </div>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="/client">Client</a>
        </li>

        <!--
        <li class="nav-item">
          <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
        </li>
        -->
      </ul>
      <!--
      <form class="form-inline my-2 my-lg-0">
        <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
      </form>
      -->
    </div>
  </nav>
  
  <!-- Content -->
  <div class="jumbotron">
    <!-- Header -->
    <div class="container">
      <div class="row">
        <div class="col">
          <h1 class="display-4">Admin Page (Share Reconstruction)</h1>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <p class="lead">Use this panel to upload the cheque and your share to reconstruct!</p>
          <hr class="my-4">
        </div>
      </div>
    </div>

    <!-- Form -->
    <form name="reconstruct" method="post" enctype="multipart/form-data">
      <div class="container">
        <div class="row">
          <div class="col-6 input-group mb-2">
              <div class="custom-file">
                  <input type="file" class="custom-file-input" id="cheque-upload" required>
                  <label class="custom-file-label" for="inputGroupFile02" aria-describedby="inputGroupFileAddon02">Choose Client Cheque</label>
              </div>
          </div>
        </div>

        <div class="row">
          <div class="col-6 input-group mb-2">
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="bankshare-upload" required>
                <label class="custom-file-label" for="inputGroupFile02" aria-describedby="inputGroupFileAddon02">Choose Bank Share</label>
            </div>
          </div>
        </div>

        <div class="row">
            <div class="col-5">
              <div id="loader"></div>
            </div>
        </div>

        <div class="row">
          <div class="row">
            <div class="col-3">
                <a id="downloadLink" target="_blank" value="client_share" download><div id="preview1" style="margin-left: 20px; margin-bottom: 10px; max-height: 500px; max-width: 500px"></div></a>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-12">
            <div id="response-msg" class="alert alert-danger" role="alert" style="width:49%; text-align: center"></div>
          </div>
        </div>

        <div class="row">
          <div class="col-12">
            <button class="btn btn-primary btn-lg active" type="submit" aria-pressed="true" style="width:49%">Reconstruct Shares</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</body>

<script>
  $('#response-msg').hide();
  $('#preview1').hide();

  // change the name of the input file when a file is uploaded
  $(".custom-file-input").on("change", function() {
      var fileName = $(this).val().split("\\").pop();
      $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
  });

  // execute this when the form is submitted
  $(reconstruct).submit(function(e) 
  {
    e.preventDefault(); // avoid to execute the actual submit of the form.

    document.getElementById("loader").style.display = "block";
    $('#preview1').hide();
    $('#response-msg').hide();
    
    encodeImageFileAsURL()
  });

  // function to get the image file
  function encodeImageFileAsURL()
  {
    var cheque = document.getElementById("cheque-upload").files;
    var share = document.getElementById("bankshare-upload").files;

    // checks if both of the fields are filled
    if (cheque.length > 0 && share.length > 0) 
    {
      var fileToLoad1 = cheque[0];
      var filereader1 = new FileReader();
      var fileToLoad2 = share[0];
      var filereader2 = new FileReader();

      // only runs when the client's cheque is fully loaded
      filereader1.onload = function(fileLoadedEvent) 
      {
        // get filename
        var fullPath = document.getElementById('bankshare-upload').value;
        if (fullPath) 
        {
          var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
          var filename = fullPath.substring(startIndex);
          if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
              filename = filename.substring(1);
          }
        }
        else {
          filename="Unknown"
        }

        // bade64 data of the client's cheque
        srcData1 = fileLoadedEvent.target.result; 

        // only runs when the bank share is fully loaded
        filereader2.onload = function(fileLoadedEvent) 
        {
          // base64 data of the server's share
          srcData2 = fileLoadedEvent.target.result; 

          // store image (base64)
          var fd = new FormData();

          // updates UI
          $('#cheque-upload').addClass('is-valid');
          $('#bankshare-upload').addClass('is-valid');

          // send to server via AJAX
          fd.append('file1',srcData1)
          fd.append('file2',srcData2)
          fd.append('filename', filename)

          var formData = new FormData(document.getElementById("clientForm"));
          $.ajax({
            type: 'post',
            url: '/bank-reconstruct',
            data: fd,
            mimeType:"multipart/form-data",
            contentType: false,
            cache: false,
            processData: false,
            success: function(response){
              if(response != 0)
              {
                var result = response.split(",");
                picture = result[0]
                filename = result[1]

                // allows bank to download the reconstructed image 
                var png_download = "data:image/png;base64,";
                png_download += picture;

                var newImage = document.createElement('img');
                newImage.src = png_download;
                newImage.height = 400;
                newImage.width = 500;
                document.getElementById("preview1").innerHTML = newImage.outerHTML;

                // creates a downloadable link
                var a = document.getElementById('downloadLink'); //or grab it by tagname etc
                a.href = png_download;
                a.download = filename + "_reconstructed_cheque";

                // updates UI
                document.getElementById("loader").style.display = "none";
                $('#preview1').show();
                $('#cheque-upload').removeClass('is-invalid');
                $('#bankshare-upload').removeClass('is-invalid');
                $('#response-msg').removeClass('alert-danger');
                $('#response-msg').addClass('alert-success');
                $('#cheque-upload').addClass('is-valid');
                $('#bankshare-upload').addClass('is-valid');
                $("#response-msg").text("Click on the image to download the reconstructed cheque.");
                $('#response-msg').toggle();
              } 
              
              else
              { 
                document.getElementById("loader").style.display = "none";
                $('#cheque-upload').addClass('is-invalid');
                $('#bankshare-upload').addClass('is-invalid');
                $('#response-msg').addClass('alert-danger');
                $("#response-msg").text("Bank share and client share doesn't have the same dimension (i.e. same width and height)");
                $('#response-msg').toggle();
              }
            },

            error: function(jqXHR, textStatus, errorThrown) 
            {}
          });
        }
      }
      
      filereader1.readAsDataURL(fileToLoad1);   
      filereader2.readAsDataURL(fileToLoad2);          
    }
  }
</script>