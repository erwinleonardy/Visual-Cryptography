{% include "header.html" %}

{% if 'admin' in usertype %}
<!-- Body -->
<body class = "body">
  <!-- Nav Bar -->
  {% with page_type="Bank", active_page="generate" %}
    {% include "navbar.html" %}
  {% endwith %}

  <!-- Content -->
  <div class="jumbotron">
    <!-- Header -->  
    <div class="container">
      <div class="row">
        <div class="col">
          <h1 class="display-4">Admin Page (Share Generation)</h1>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <p class="lead">Use this panel to create 2 shares of a signature!</p>
          <hr class="my-4">
        </div>
      </div>
    </div>

    <!-- Form -->
    <form name="generation" method="post" enctype="multipart/form-data">
      <div class="container">
        <div class="row">
          <div class="col-xs-6 col-sm-12 col-md-12 col-lg-6 input-group mb-2">
              <div class="custom-file">
                  <input type="file" class="custom-file-input" id="signature-upload" required>
                  <label class="custom-file-label" for="signature-upload" aria-describedby="inputGroupFileAddon02">Choose Signature</label>
              </div>
          </div>
        </div>

        <div class="row">
          <div class="col-xs-6 col-sm-12 col-md-12 col-lg-6 input-group mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text" id="basic-addon1">Client's Email</span>
            </div>
            <input type="text" id="email_input" class="form-control" placeholder="johndoe@vsignit.com" aria-label="Username" aria-describedby="basic-addon1" required>
          </div>
        </div>

        <div class="row">
            <div class="col-xs-6 col-sm-12 col-md-12 col-lg-6">
              <div id="loader"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-6 col-sm-12 col-md-12 col-lg-6">
              <a id="downloadLink" target="_blank" value="bank_share" download><div id="preview" style="margin-bottom: 10px; max-height: 200px; max-width: 200px"></div></a>
            </div>
        </div>

        <div class="row">
          <div class="col-xs-6 col-sm-12 col-md-12 col-lg-6">
            <div id="response-msg" class="alert alert-danger animate-bottom" role="alert" style="width:100%; text-align: center">
                Please ensure that you have entered the correct email!
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-xs-6 col-sm-12 col-md-12 col-lg-6">
            <button class="btn btn-primary btn-lg active" type="submit" aria-pressed="true" style="width:100%">Generate Shares</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</body>

<script>
  $('#response-msg').hide();
  $('#preview').hide();

  // change the name of the input file when a file is uploaded
  $(".custom-file-input").on("change", function() {
      var fileName = $(this).val().split("\\").pop();
      $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
  });

  // execute this when the form is submitted
  $(generation).submit(function(e) 
  {
    e.preventDefault(); // avoid to execute the actual submit of the form.
    
    $('#preview').hide();
    $('#response-msg').hide();
    document.getElementById("loader").style.display = "block";

    // checks if the email is in the correct format
    if (validate())
      encodeImageFileAsURL()
  });

  // regex to check email
  function validateEmail(email) 
  {
    var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(String(email).toLowerCase());
  }

  // show the response message based on user's input
  function validate() 
  {
    var email = $(email_input).val()

    if (validateEmail(email)) {
      $('#email_input').removeClass('is-invalid');
      $('#email_input').addClass('is-valid');
      $('#response-msg').hide();
      return true;
    } 

    else
    {
      document.getElementById("loader").style.display = "none";
      $("#response-msg").text("Please ensure that you have entered the correct email!");
      $('#email_input').addClass('is-invalid');
      $('#response-msg').toggle();
      return false;
    }
  }

  // function to get the image file
  function encodeImageFileAsURL()
  {
    var filesSelected = document.getElementById("signature-upload").files;

    // checks if the image and email are provided
    if (filesSelected.length > 0) 
    {
      var fileToLoad = filesSelected[0];
      var fileReader = new FileReader();

      // only runs when the image provided is fully loaded
      fileReader.onload = function(fileLoadedEvent) 
      {
        // get filename
        var fullPath = document.getElementById('signature-upload').value;
        if (fullPath) 
        {
          var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
          var filename = fullPath.substring(startIndex);
          if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
              filename = filename.substring(1);
          }
        }
        else {
          filename="Unknown"
        }

        // base64 data of the original signature
        srcData = fileLoadedEvent.target.result; 
        
        // store email and image (base64)
        var fd = new FormData();
        var email = $(email_input).val()
        var imgsrc = document.getElementById("preview").src;

        // send to server via AJAX
        fd.append('email', email)
        fd.append('file',srcData)
        fd.append('filename', filename)

        var formData = new FormData(document.getElementById("generation"));
        $.ajax({
          type: 'post',
          url: '/bank-generate',
          data: fd,
          mimeType:"multipart/form-data",
          contentType: false,
          cache: false,
          processData: false,
          success: function(response){
            // when the image provided has the correct dimension
            if(response != 0)
            {
              var result = response.split(",");
              picture = result[0]
              filename = result[1]
              
              // allows bank to download the reconstructed image 
              var png_download = "data:image/png;base64,"
              png_download += picture

              var newImage = document.createElement('img');
              newImage.src = png_download;
              newImage.height = 200;
              newImage.width = 200;
              document.getElementById("preview").innerHTML = newImage.outerHTML;

              // creates a downloadable link
              var a = document.getElementById('downloadLink'); //or grab it by tagname etc
              a.href = png_download
              a.download = filename + "_bank_share"
              
              // updates UI
              document.getElementById("loader").style.display = "none";
              $('#preview').show();
              $('#signature-upload').removeClass('is-invalid');
              $('#signature-upload').addClass('is-valid');
              $('#response-msg').removeClass('alert-danger');
              $('#response-msg').addClass('alert-success');
              $("#response-msg").text("Click on the image to download your share. The other share has been sent to \'" + email + "\'");
              $('#response-msg').toggle();
            } 
            
            // when the image provided has incorrect dimension
            else
            {
              document.getElementById("loader").style.display = "none";
              $('#signature-upload').addClass('is-invalid');
              $('#response-msg').addClass('alert-danger');
              $("#response-msg").text("The image should have the correct dimension (i.e. same width and height)!");
              $('#response-msg').toggle();
            }
          },

          error: function(jqXHR, textStatus, errorThrown) 
          {}
        });
      }

      fileReader.readAsDataURL(fileToLoad);
    }
  }
</script>

{% else %}
  {% include "forbidden.html" %}
{% endif %}

</html>